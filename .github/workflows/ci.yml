name: CI (build, lint, test)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-lint-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies (CMake, compiler, lint tools)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake build-essential \
            clang-format cppcheck

      - name: Configure (CMake)
        run: |
          mkdir -p build
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      # ---------- clang-format (style check) ----------
      
      - name: clang-format (style check)
        
        run: |
          # Decide which files to check
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR event → only changed C/C++ files relative to base branch: ${{ github.base_ref }}"
            git fetch origin ${{ github.base_ref }} --depth=1
            files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- \
              '*.h' '*.hpp' '*.c' '*.cc' '*.cpp' '*.cxx' '*.tpp')
          else
            echo "Push event → all tracked C/C++ files"
            files=$(git ls-files '*.h' '*.hpp' '*.c' '*.cc' '*.cpp' '*.cxx' '*.tpp')
          fi

          if [ -z "$files" ]; then
            echo "No C/C++ files to check, skipping clang-format."
            exit 0
          fi

          clang-format --version
          echo "$files" | xargs -I{} clang-format --dry-run -Werror "{}"
      
      
      
      # ---------- cppcheck ----------

      
      - name: Static analysis (cppcheck)
          if:false  
        
        run: |
          # Decide which files to check
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR event → only changed C/C++ files relative to base branch: ${{ github.base_ref }}"
            git fetch origin ${{ github.base_ref }} --depth=1
            files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- \
              '*.c' '*.cc' '*.cpp' '*.cxx' '*.h' '*.hpp' '*.tpp')
          else
            echo "Push event → all tracked C/C++ files"
            files=$(git ls-files '*.c' '*.cc' '*.cpp' '*.cxx' '*.h' '*.hpp' '*.tpp')
          fi

          if [ -z "$files" ]; then
            echo "No C/C++ files to check, skipping cppcheck."
            exit 0
          fi

          echo "Running cppcheck on:"
          echo "$files"

          cppcheck \
            --enable=all \
            --error-exitcode=1 \
            --std=c++20 \
            --inline-suppr \
            --quiet \
            --suppress=missingIncludeSystem \
            --suppress=*:*build/* \
            $files
            
      
      
      - name: Build
        run: |
          cmake --build build --config Release -- -j"$(nproc)"

      - name: Run tests (CTest)
        run: |
          cd build
          ctest --output-on-failure

      - name: Deploy
        run: |
          echo "✅ All checks passed. Deploying..."
          # your deploy commands go here

      

      

          
